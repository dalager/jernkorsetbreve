# Jernkorset - Docker Compose Configuration
# Local development environment for the letter collection webapp
#
# Usage:
#   docker compose up              # Start all services
#   docker compose up -d           # Start in detached mode
#   docker compose up api          # Start only the API
#   docker compose logs -f         # Follow logs
#   docker compose down            # Stop all services
#
# Testing:
#   docker compose run --rm e2e    # Run E2E tests
#   docker compose --profile test up  # Start services + run tests
#
# Services:
#   - api:         FastAPI backend (port 8000)
#   - frontend:    React dashboard (port 5173)
#   - public-site: Next.js public site (port 3000)
#   - e2e:         Playwright E2E tests (profile: test)

services:
  # FastAPI Backend
  api:
    build:
      context: ./webapp/api
      dockerfile: Dockerfile
    container_name: jernkorset-api
    ports:
      - "8000:8000"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      # Mount data directory for CSV access
      - ./webapp/data:/app/data:ro
      # Mount API source for hot-reload in development
      - ./webapp/api:/app/src:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/letters"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # React Frontend (Vite dev server)
  frontend:
    build:
      context: ./webapp/frontend
      dockerfile: Dockerfile
    container_name: jernkorset-frontend
    ports:
      - "5173:5173"
    environment:
      # Use Vite proxy for API requests in Docker (no VITE_API_URL means /api is used)
      - API_PROXY_TARGET=http://api:8000
    volumes:
      # Mount source files for hot-reload in development
      - ./webapp/frontend/src:/app/src
      - ./webapp/frontend/index.html:/app/index.html
      - ./webapp/frontend/tailwind.config.ts:/app/tailwind.config.ts
      - ./webapp/frontend/vite.config.ts:/app/vite.config.ts
      # Exclude node_modules to use container's installed dependencies
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

  # Next.js Public Site
  public-site:
    build:
      context: ./webapp/public-site
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=http://localhost:8000
    container_name: jernkorset-public
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

  # E2E Tests (Playwright)
  e2e:
    build:
      context: ./tests/e2e
      dockerfile: Dockerfile
    container_name: jernkorset-e2e
    environment:
      - FRONTEND_URL=http://frontend:5173
      - API_URL=http://api:8000
      - SKIP_MODERNIZATION=true
    depends_on:
      api:
        condition: service_healthy
      frontend:
        condition: service_started
    networks:
      - default
    profiles:
      - test
    # Wait for frontend to be ready before running tests
    command: >
      sh -c "
        echo 'Waiting for frontend to be ready...' &&
        sleep 10 &&
        npx playwright test --reporter=list
      "

  # Production frontend (nginx serving static build)
  frontend-prod:
    build:
      context: ./webapp/frontend
      dockerfile: Dockerfile.prod
      args:
        - VITE_API_URL=${PRODUCTION_API_URL:-http://localhost:8000}
    container_name: jernkorset-frontend-prod
    ports:
      - "8080:80"
    depends_on:
      api:
        condition: service_healthy
    profiles:
      - production
    restart: unless-stopped

# Named volumes for persistent data (if needed in future)
volumes:
  api-cache:

# Network configuration
networks:
  default:
    name: jernkorset-network
